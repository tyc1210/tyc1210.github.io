## 消息丢失情况

**消息传递语义**

- **at most once**：最多一次。消息可能丢失也可能被处理，但最多只会被处理一次。
- **at least once**：至少一次。消息不会丢失，但可能被处理多次。可能重复，不会丢失。
- **exactly once**：精确传递一次。消息被处理且只会被处理一次。不丢失不重复就一次。

### 生产者发送数据

kafka发送消息两种方式：同步(默认)和异步

Kafka通过配置request.required.acks属性来确认消息的生产

- 0表示不进行消息接收是否成功的确认
  - 消息未发送成功造成对视
- 1表示当Leader接收成功时确认(默认)
  - leader确认后挂掉了，选举出的新leader还未完成数据同步
- -1或者all表示Leader和Follower都接收成功时确认
  - 会有重发的问题

### KafkaBroker存储数据

当往磁盘文件写入的时候，系统会先将数据流写入缓存中，至于什么时候将缓存的数据写入文件中是由操作系统自行决定。

Kafka提供了一个参数 producer.type 来控制是不是主动flush，如果Kafka写入到mmap之后就立即 flush 然后再返回 Producer 叫同步 (sync)；写入mmap之后立即返回 Producer 不调用 flush 叫异步 (async)。

如果数据已经写入系统 cache 中但是还没来得及刷入磁盘，此时突然机器宕机或者掉电那就丢了

### 消费者消费数据

消费者通过pull模式主动的去 kafka 集群拉取消息，消费消息分为两个阶段，commit offset坐标和处理消息，如果先commit处理消息异常会造成消息丢失，如果先处理消息，再commit可能会有重复消费的情况发生。